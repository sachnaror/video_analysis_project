<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Video Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #111; color: #fff; }
        .sidebar { background-color: #333; padding: 20px; height: 100vh; }
        .main { padding: 20px; }
        .progress { height: 20px; }
        .result-section, #chat-section { margin-top: 20px; padding: 20px; background-color: #222; border-radius: 10px; }
        .chat-box { height: 300px; overflow-y: auto; background-color: #333; padding: 10px; border-radius: 5px; }
        .chat-message { margin-bottom: 10px; padding: 8px; border-radius: 5px; }
        .user-message { background-color: #007bff; color: white; text-align: right; }
        .ai-message { background-color: #28a745; color: white; text-align: left; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar (Maintaining Configuration UI) -->
            <div class="col-md-3 sidebar">
                <h4>üîß Configuration</h4>
                <label for="apiKey" class="form-label">OpenAI API Key</label>
                <input type="password" id="apiKey" class="form-control mb-3" placeholder="Enter API Key">
                <button id="saveKey" class="btn btn-success w-100">Save API Key</button>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 main">
                <h2>üé• AI Video Analysis</h2>
                <p>Upload a video for AI-powered analysis.</p>

                <div class="mb-3">
                    <label for="videoInput" class="form-label">Upload Video</label>
                    <input type="file" id="videoInput" class="form-control" accept="video/*">
                </div>
                <button id="processVideoBtn" class="btn btn-primary">üîç Process Video</button>




                <div class="progress mt-3 d-none">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar" style="width: 0%;">0%</div>
                </div>
                <p id="progressStage" class="text-info mt-2">Waiting for processing...</p>  <!-- ‚úÖ Added -->

                <div id="chat-section" class="d-none">
                    <h4>üí¨ Chat History</h4>
                    <div class="chat-box" id="chatHistory"></div>
                    <input type="text" id="userQuery" class="form-control mb-2" placeholder="Ask about the video">
                    <button id="askBtn" class="btn btn-warning">Ask</button>
                </div>
            </div>
        </div>
    </div>

    <form id="uploadForm" enctype="multipart/form-data">
        <input type="file" id="videoFile" name="video" required>
        <button type="submit">Upload & Process</button>
    </form>


    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


    <script>
    document.getElementById("uploadForm").addEventListener("submit", async (event) => {
        event.preventDefault();

        let fileInput = document.getElementById("videoFile");
        if (!fileInput.files.length) {
            alert("Please select a video file.");
            return;
        }

        let formData = new FormData();
        formData.append("video", fileInput.files[0]);

        let response = await fetch("/upload_video/", {
            method: "POST",
            body: formData
        });

        let data = await response.json();
        alert(data.message || data.error);
    });
    </script>


    <script>
        function scrollToBottom() {
            let chatBox = document.getElementById("chatHistory");
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Load API Key from sessionStorage when page loads
        $(document).ready(() => {
            const savedApiKey = sessionStorage.getItem("openai_api_key");
            if (savedApiKey) {
                $("#apiKey").val(savedApiKey);
            }
        });

        // Save API Key in sessionStorage
        $("#saveKey").click(() => {
            let apiKey = $("#apiKey").val().trim();
            if (apiKey) {
                sessionStorage.setItem("openai_api_key", apiKey);
                alert("API Key saved for this session!");
            } else {
                alert("Please enter a valid API Key.");
            }
        });

        $("#processVideoBtn").click(() => {
            $(".progress").removeClass("d-none");

            let interval = setInterval(async () => {
                let response = await fetch('/progress');
                let data = await response.json();
                let progress = data.progress;

                $("#progressBar").css("width", progress + "%").text(progress + "%");

                if (progress >= 100) {
                    clearInterval(interval);
                    $("#chat-section").removeClass("d-none");
                }
            }, 2000);
        });

        $("#askBtn").click(async () => {
            let query = $("#userQuery").val().trim();
            let apiKey = sessionStorage.getItem("openai_api_key");

            if (!query) return alert("Please enter a question!");
            if (!apiKey) return alert("Please enter and save your API Key!");

            $("#chatHistory").append(`<div class='chat-message user-message'>${query}</div>`);
            scrollToBottom();

            let response = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question: query, api_key: apiKey })
            });

            let data = await response.json();
            $("#chatHistory").append(`<div class='chat-message ai-message'>${data.response}</div>`);
            scrollToBottom();
        });
    </script>

    <input type="file" id="fileInput">
<button id="uploadFileBtn">Upload File</button>

<script>
$("#uploadFileBtn").click(async () => {
    let fileInput = document.getElementById("fileInput");
    if (!fileInput.files.length) {
        alert("Please select a file.");
        return;
    }

    let formData = new FormData();
    formData.append("file", fileInput.files[0]);

    let response = await fetch("/upload_file/", {
        method: "POST",
        body: formData
    });

    let data = await response.json();
    alert(data.message || data.error);
});
</script>
</body>
</html>
